<script type="module">
        import Privy, { LocalStorage } from 'https://esm.sh/@privy-io/js-sdk-core@latest';
        // We use ethers.js to make sending money easier (handling decimals, etc.)
        import { ethers } from 'https://esm.sh/ethers@6.7.0';

        // ================= CONFIGURATION =================
        const APP_ID = 'cmitb8a5900p6l40c4tkqqwbq'; 
        const CLIENT_ID = 'client-WY6TPxCtXyQ7hbZmtXpqQ4hML83kmRDPuKZUoriz1TQVq';
        
        // REPLACE THIS WITH YOUR REAL ETHEREUM WALLET ADDRESS
        const CHURCH_WALLET = '0x0828C77922838a06587eBe8463aDBDeD6eb95f74'; 
        // =================================================

        const statusMsg = document.getElementById('status');
        const connectBtn = document.getElementById('connect-wallet');
        const amountInput = document.getElementById('amount');
        const currencySelect = document.getElementById('currency');

        // Initialize Privy
        const privy = new Privy({
            appId: APP_ID,
            clientId: CLIENT_ID,
            storage: new LocalStorage()
        });

        // Mount the invisible security iframe
        const iframe = document.createElement('iframe');
        iframe.src = privy.embeddedWallet.getURL();
        iframe.id = "privy-iframe";
        document.body.appendChild(iframe);
        privy.setMessagePoster(iframe.contentWindow);
        window.addEventListener('message', (e) => privy.embeddedWallet.onMessage(e.data));

        // 1. HELPER: The function that actually sends the money
        async function performTithe(user) {
            const amount = amountInput.value;
            const currency = currencySelect.value;

            if (!amount || amount <= 0) {
                alert("Please enter a valid amount to tithe.");
                return;
            }

            if (CHURCH_WALLET.includes('0x0000')) {
                alert("CONFIG ERROR: The Church wallet address has not been set in the code.");
                return;
            }

            try {
                statusMsg.innerText = `Preparing to tithe ${amount} ${currency}...`;
                
                // Get the provider from the embedded wallet
                const embeddedProvider = await privy.embeddedWallet.getEthereumProvider();
                const provider = new ethers.BrowserProvider(embeddedProvider);
                const signer = await provider.getSigner();

                // Check specific currencies
                if (currency === 'ETH') {
                    // Send ETH
                    const tx = await signer.sendTransaction({
                        to: CHURCH_WALLET,
                        value: ethers.parseEther(amount.toString()) // Converts 0.01 to Wei
                    });
                    
                    statusMsg.innerText = "Transaction Sent! Hash: " + tx.hash;
                    statusMsg.style.color = "green";
                    console.log("Transaction:", tx);
                    alert("Bless you. The tithe has been received (on-chain).");
                } 
                else {
                    // Placeholder for USDC/SOL complexity
                    statusMsg.innerText = `Support for ${currency} is coming in the next update. Please tithe in ETH.`;
                }

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Tithe Failed: " + error.message;
                statusMsg.style.color = "red";
            }
        }

        // 2. CHECK LOGIN ON LOAD (So they don't have to log in every time)
        // We give it a second to initialize
        setTimeout(async () => {
            try {
                const session = await privy.auth.getSession(); // Check if session exists
                if (session) {
                    console.log("User already logged in");
                    connectBtn.innerText = "TITHE NOW";
                    statusMsg.innerText = "Welcome back, faithful.";
                    
                    // Update button to skip login and go straight to tithe
                    connectBtn.onclick = () => performTithe(session.user);
                } else {
                    // 3. IF NOT LOGGED IN, ATTACH LOGIN LISTENER
                    connectBtn.onclick = handleLogin;
                }
            } catch (e) {
                console.log("No existing session");
                connectBtn.onclick = handleLogin;
            }
        }, 1000);

        // 4. LOGIN HANDLER
        async function handleLogin() {
            const email = prompt("Enter email to connect wallet:");
            if (!email) return;

            try {
                statusMsg.innerText = `Sending code to ${email}...`;
                await privy.auth.email.sendCode(email);
                
                const code = prompt("Enter verification code:");
                if (!code) return;

                const session = await privy.auth.email.loginWithCode(email, code);
                
                statusMsg.innerText = "Wallet Connected.";
                connectBtn.innerText = "TITHE NOW";
                
                // Immediately ask to tithe after login
                await performTithe(session.user);

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "Error: " + err.message;
            }
        }
    </script>
