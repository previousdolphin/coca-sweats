<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoCA | Tithe</title>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #1a1a1a;
            --accent-color: #0000ff;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .coca-header {
            max-width: 300px;
            width: 100%;
            margin-bottom: 40px;
            mix-blend-mode: multiply; 
        }
        
        .coca-header img {
            width: 100%;
            height: auto;
            border: 1px solid var(--text-color);
        }

        .tithe-container {
            border: 2px solid var(--text-color);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            background: white;
            box-shadow: 10px 10px 0px var(--text-color);
        }

        h1 {
            text-transform: uppercase;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--text-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        input[type="number"], 
        select {
            width: 100%;
            padding: 10px;
            font-family: var(--font-main);
            border: 1px solid var(--text-color);
            background: #eee;
            box-sizing: border-box;
        }

        button#connect-wallet {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            font-family: var(--font-main);
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.1s;
        }

        button#connect-wallet:hover {
            background-color: var(--text-color);
        }

        button#connect-wallet:active {
            transform: translate(2px, 2px);
        }

        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
        }

        .status-msg {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            word-wrap: break-word;
        }

        #privy-iframe {
            width: 0; height: 0; border: none; position: absolute; visibility: hidden;
        }
    </style>
</head>
<body>

    <div class="coca-header">
        <img src="CoCA-Vector-redrawn-photoshop.svg" alt="Church of Conceptual Art">
    </div>

    <div class="tithe-container">
        <h1>Absolution / Tithe</h1>
        
        <div class="input-group">
            <label for="currency">Denomination</label>
            <select id="currency">
                <option value="ETH">ETH (Ether)</option>
                <option value="USDC">USDC (Coming Soon)</option>
            </select>
        </div>

        <div class="input-group">
            <label for="amount">Amount</label>
            <input type="number" id="amount" placeholder="0.00" step="0.01">
        </div>

        <button id="connect-wallet">Initialize Protocol</button>

        <div class="status-msg" id="status">
            * All transactions are final and purely conceptual until validated on-chain.
        </div>
    </div>

    <script type="module">
        import Privy, { LocalStorage } from 'https://esm.sh/@privy-io/js-sdk-core@latest';
        import { ethers } from 'https://esm.sh/ethers@6.7.0';

        // === CONFIG ===
        const APP_ID = 'cmitb8a5900p6l40c4tkqqwbq'; 
        const CLIENT_ID = 'client-WY6TPxCtXyQ7hbZmtXpqQ4hML83kmRDPuKaAQgMAtGWCj';
        const CHURCH_WALLET = '0x0828C77922838a06587eBe8463aDBDeD6eb95f74'; 
        // ==============

        const statusMsg = document.getElementById('status');
        const connectBtn = document.getElementById('connect-wallet');
        const amountInput = document.getElementById('amount');
        const currencySelect = document.getElementById('currency');

        const privy = new Privy({
            appId: APP_ID,
            clientId: CLIENT_ID,
            storage: new LocalStorage()
        });

        // Mount Iframe
        try {
            const iframe = document.createElement('iframe');
            iframe.src = privy.embeddedWallet.getURL();
            iframe.id = "privy-iframe";
            document.body.appendChild(iframe);
            privy.setMessagePoster(iframe.contentWindow);
            window.addEventListener('message', (e) => privy.embeddedWallet.onMessage(e.data));
        } catch (e) {
            console.error("Iframe Error:", e);
        }

        // --- HELPER: ROBUST WALLET FINDER & CREATOR ---
        async function ensureWalletExists() {
            const user = privy.user;
            if (!user) throw new Error("User not found");

            // FIX: Safely access linkedAccounts with a fallback to empty array
            const linkedAccounts = user.linkedAccounts || [];
            
            const embeddedWallet = linkedAccounts.find(
                (account) => account.type === 'wallet' && account.walletClientType === 'privy'
            );

            if (embeddedWallet) {
                console.log("Found existing embedded wallet:", embeddedWallet);
                return embeddedWallet;
            }

            // If we get here, we didn't find it in the list.
            statusMsg.innerText = "Initializing secure container...";
            
            try {
                // Try to create it.
                // If it already exists (but was invisible in linkedAccounts), this might throw an error.
                const wallet = await privy.embeddedWallet.create({ 
                    recoveryMethod: 'privy-managed' 
                });
                console.log("Wallet created:", wallet);
                return wallet;
            } catch (err) {
                // If the error suggests it already exists, we are actually fine.
                // We just proceed to use it.
                if (err.message && (err.message.includes("400") || err.message.includes("already has"))) {
                    console.log("Wallet already exists on server, proceeding...");
                    return; // Returning undefined is fine, getEthereumProvider will still work
                }
                // If it's a different error, re-throw it
                throw err;
            }
        }

        // 3. Tithe Function
        async function performTithe() {
            const amount = amountInput.value;
            const currency = currencySelect.value;

            if (!amount || amount <= 0) {
                alert("Please enter a valid amount.");
                return;
            }

            try {
                connectBtn.disabled = true;
                statusMsg.innerText = "Verifying wallet status...";

                if (!privy.user) {
                    await handleLogin();
                    return;
                }

                await ensureWalletExists();

                statusMsg.innerText = "Connecting to embedded wallet...";
                
                // This call works as long as the wallet exists on the backend
                const embeddedProvider = await privy.embeddedWallet.getEthereumProvider();
                const provider = new ethers.BrowserProvider(embeddedProvider);
                const signer = await provider.getSigner();

                if (currency === 'ETH') {
                    statusMsg.innerText = "Sign the transaction in the popup...";
                    
                    const tx = await signer.sendTransaction({
                        to: CHURCH_WALLET,
                        value: ethers.parseEther(amount.toString())
                    });
                    
                    statusMsg.innerText = "Sent! Hash: " + tx.hash;
                    statusMsg.style.color = "green";
                    console.log(tx);
                } else {
                    alert("Only ETH is supported in this version.");
                    statusMsg.innerText = "Transaction Cancelled.";
                }

            } catch (error) {
                console.error(error);
                statusMsg.style.color = "red";
                if (error.message && error.message.includes('frame')) {
                    statusMsg.innerText = "Error: Domain not allowed in Privy Dashboard.";
                } else {
                    statusMsg.innerText = "Error: " + error.message;
                }
            } finally {
                connectBtn.disabled = false;
            }
        }

        // 4. Initialization Logic
        window.addEventListener('load', async () => {
            if (!connectBtn) return;

            let attempts = 0;
            const checkSession = setInterval(async () => {
                attempts++;
                try {
                    const user = privy.user;
                    if (user) {
                        console.log("User found:", user);
                        connectBtn.innerText = "TITHE NOW";
                        statusMsg.innerText = "Welcome back, initiate.";
                        connectBtn.onclick = performTithe;
                        clearInterval(checkSession);
                    } else if (attempts > 5) {
                        console.log("No active session found.");
                        connectBtn.onclick = handleLogin;
                        clearInterval(checkSession);
                    }
                } catch (e) {
                    console.error("User check failed", e);
                    connectBtn.onclick = handleLogin;
                    clearInterval(checkSession);
                }
            }, 500);
        });

        async function handleLogin() {
            const email = prompt("Enter email for Absolution:");
            if (!email) return;

            try {
                statusMsg.innerText = "Sending code to " + email + "...";
                await privy.auth.email.sendCode(email);
                
                const code = prompt("Enter the verification code:");
                if (!code) {
                    statusMsg.innerText = "Login cancelled.";
                    return;
                }

                statusMsg.innerText = "Verifying credentials...";
                await privy.auth.email.loginWithCode(email, code);
                
                // Check and create wallet immediately
                try {
                   await ensureWalletExists();
                } catch (walletErr) {
                   console.log("Initial wallet check:", walletErr);
                }

                statusMsg.innerText = "Logged in. Ready to Tithe.";
                connectBtn.innerText = "TITHE NOW";
                
                connectBtn.onclick = performTithe;
                
                if (amountInput.value > 0) {
                   await performTithe();
                }

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "Login Failed: " + err.message;
                statusMsg.style.color = "red";
            }
        }
    </script>
</body>
</html>
