<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoCA | Tithe</title>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #1a1a1a;
            --accent-color: #0000ff;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .coca-header {
            max-width: 300px;
            width: 100%;
            margin-bottom: 40px;
            mix-blend-mode: multiply; 
        }
        
        .coca-header img {
            width: 100%;
            height: auto;
            border: 1px solid var(--text-color);
        }

        .tithe-container {
            border: 2px solid var(--text-color);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            background: white;
            box-shadow: 10px 10px 0px var(--text-color);
        }

        h1 {
            text-transform: uppercase;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--text-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        input[type="number"], 
        select {
            width: 100%;
            padding: 10px;
            font-family: var(--font-main);
            border: 1px solid var(--text-color);
            background: #eee;
            box-sizing: border-box;
        }

        button.action-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            font-family: var(--font-main);
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.1s;
            margin-bottom: 10px;
        }

        button.action-btn:hover {
            background-color: var(--text-color);
        }

        button.action-btn:active {
            transform: translate(2px, 2px);
        }

        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
        }

        .status-msg {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #666;
            text-align: left;
            word-wrap: break-word;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            font-family: monospace;
        }

        .log-entry { margin-bottom: 5px; }
        .log-error { color: red; }
        .log-success { color: green; }

        #privy-iframe {
            width: 0; height: 0; border: none; position: absolute; visibility: hidden;
        }
    </style>
</head>
<body>

    <div class="coca-header">
        <img src="CoCA-Vector-redrawn-photoshop.svg" alt="Church of Conceptual Art">
    </div>

    <div class="tithe-container">
        <h1>Absolution / Tithe</h1>
        
        <div class="input-group">
            <label for="currency">Denomination</label>
            <select id="currency">
                <option value="ETH">ETH (Ether)</option>
                <option value="USDC">USDC (Coming Soon)</option>
            </select>
        </div>

        <div class="input-group">
            <label for="amount">Amount</label>
            <input type="number" id="amount" placeholder="0.00" step="0.01">
        </div>

        <button id="main-action" class="action-btn">Connect Wallet</button>

        <div class="status-msg" id="console-output">
            <div>> System Ready.</div>
        </div>
    </div>

    <script type="module">
        import Privy, { LocalStorage } from 'https://esm.sh/@privy-io/js-sdk-core@latest';
        import { ethers } from 'https://esm.sh/ethers@6.7.0';

        // === CONFIG ===
        const APP_ID = 'cmitb8a5900p6l40c4tkqqwbq'; 
        const CLIENT_ID = 'client-WY6TPxCtXyQ7hbZmtXpqQ4hML83kmRDPuKaAQgMAtGWCj';
        const CHURCH_WALLET = '0x0828C77922838a06587eBe8463aDBDeD6eb95f74'; 
        // ==============

        const outputDiv = document.getElementById('console-output');
        const actionBtn = document.getElementById('main-action');
        const amountInput = document.getElementById('amount');
        const currencySelect = document.getElementById('currency');

        // Helper for on-screen logging
        function log(msg, type = 'normal') {
            const entry = document.createElement('div');
            entry.className = type === 'error' ? 'log-entry log-error' : type === 'success' ? 'log-entry log-success' : 'log-entry';
            entry.innerText = `> ${msg}`;
            outputDiv.appendChild(entry);
            console.log(msg);
        }

        // 1. Initialize Privy
        const privy = new Privy({
            appId: APP_ID,
            clientId: CLIENT_ID,
            storage: new LocalStorage()
        });

        // 2. Mount Iframe (Crucial for embedded wallets)
        try {
            const iframe = document.createElement('iframe');
            iframe.src = privy.embeddedWallet.getURL();
            iframe.id = "privy-iframe";
            document.body.appendChild(iframe);
            privy.setMessagePoster(iframe.contentWindow);
            window.addEventListener('message', (e) => privy.embeddedWallet.onMessage(e.data));
        } catch (e) {
            log("Iframe Init Failed: " + e.message, 'error');
        }

        // --- CORE LOGIC: Get Provider Robustly ---
        async function getProviderAndSigner() {
            // 1. Check for External Wallets (MetaMask, etc.)
            const externalWallets = privy.wallets;
            if (externalWallets.length > 0) {
                log(`Found external wallet: ${externalWallets[0].walletClientType}`, 'success');
                const provider = await externalWallets[0].getEthersProvider();
                return provider.getSigner();
            }

            // 2. Fallback to Embedded Wallet
            log("Attempting to load embedded wallet...");
            
            // Try to create one. If it exists (400 error), we ignore and proceed.
            try {
                // 'privy-managed' means no password prompt for user
                await privy.embeddedWallet.create({ recoveryMethod: 'privy-managed' });
                log("Created new embedded wallet.", 'success');
            } catch (e) {
                // If error is NOT "already exists", report it.
                if (!e.message.includes("400") && !e.message.includes("already has")) {
                    log("Creation warning: " + e.message, 'error');
                } else {
                    log("Wallet already exists. Connecting...", 'success');
                }
            }

            // Now try to get the provider
            try {
                const embeddedProvider = await privy.embeddedWallet.getEthereumProvider();
                const provider = new ethers.BrowserProvider(embeddedProvider);
                return provider.getSigner();
            } catch (e) {
                throw new Error("Could not connect to any wallet. " + e.message);
            }
        }

        // --- ACTION: Tithe ---
        async function performTithe() {
            const amount = amountInput.value;
            const currency = currencySelect.value;

            if (!amount || amount <= 0) {
                alert("Please enter a valid amount.");
                return;
            }

            try {
                actionBtn.disabled = true;
                actionBtn.innerText = "Processing...";
                log("Initiating transaction...");

                const signer = await getProviderAndSigner();
                
                log("Requesting signature...");
                
                if (currency === 'ETH') {
                    const tx = await signer.sendTransaction({
                        to: CHURCH_WALLET,
                        value: ethers.parseEther(amount.toString())
                    });
                    
                    log("Transaction Sent!", 'success');
                    log("Hash: " + tx.hash);
                    actionBtn.innerText = "TITHE AGAIN";
                } else {
                    alert("Only ETH is supported.");
                    log("Cancelled: Unsupported Currency", 'error');
                }

            } catch (error) {
                log("Transaction Failed: " + error.message, 'error');
                console.error(error);
            } finally {
                actionBtn.disabled = false;
                if(actionBtn.innerText === "Processing...") actionBtn.innerText = "TITHE NOW";
            }
        }

        // --- ACTION: Connect / Login ---
        async function handleConnect() {
            try {
                log("Opening connection modal...");
                // This replaces the custom email prompt. 
                // It opens the official Privy UI for Email, SMS, or External Wallets.
                await privy.connectWallet(); 
                
                log("Connected.", 'success');
                updateUIState();
            } catch (e) {
                log("Connection failed: " + e.message, 'error');
            }
        }

        function updateUIState() {
            const user = privy.user;
            if (user) {
                console.dir(user); // Dump user to console for debugging
                log(`User: ${user.id.substring(0,8)}...`);
                actionBtn.innerText = "TITHE NOW";
                actionBtn.onclick = performTithe;
            } else {
                actionBtn.innerText = "Connect Wallet";
                actionBtn.onclick = handleConnect;
            }
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            log("Checking session...");
            setTimeout(() => {
                updateUIState();
            }, 1000);
        });

    </script>
</body>
</html>
