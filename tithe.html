<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NAMEOFMY | TITHES</title>
    <style>
        /* --- BRUTALIST RESET --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --brand-red: #ff3333; }
        body { background-color: #ffffff; color: #000000; font-family: 'Courier New', Courier, monospace; width: 100vw; min-height: 100vh; overflow-x: hidden; position: relative; transition: background-color 0.3s, color 0.3s; }
        .uppercase { text-transform: uppercase; }
        .hidden { display: none !important; }

        /* DARK MODE */
        body.dark-mode { background-color: #000000; color: #ffffff; }
        body.dark-mode #gate { background: #000000; color: #ffffff; }
        body.dark-mode .brutalist-input { background: #000000; color: #ffffff; border: 2px solid white; }
        body.dark-mode .brutalist-btn { background: white; color: black; border: 2px solid white; }
        body.dark-mode .brutalist-btn:hover { background: black; color: white; border: 2px solid white; }
        body.dark-mode .receipt-box { border: 2px solid white; background: black; }
        body.dark-mode .receipt-header { border-bottom: 1px solid white; }
        body.dark-mode .data-terminal { border-color: white; }
        body.dark-mode .header-logo { filter: invert(100%); }

        /* GATE */
        #gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .gate-logo { width: 180px; height: auto; margin-bottom: 30px; filter: invert(28%) sepia(99%) saturate(7456%) hue-rotate(356deg) brightness(101%) contrast(106%); pointer-events: none; user-select: none; }

        /* LAYOUT */
        .shop-container { display: flex; flex-direction: column; min-height: 100vh; width: 100%; }
        .top-bar { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 20px; padding-top: max(20px, env(safe-area-inset-top)); z-index: 10; }
        .header-group { display: flex; align-items: center; gap: 20px; }
        .header-logo { height: 3.5rem; width: auto; display: block; }
        .header { font-size: 1.5rem; font-weight: bold; }
        .status-indicator { font-size: 1rem; font-weight: bold; color: var(--brand-red); }

        /* CONTROLS */
        .dark-mode-toggle-btn { background: none; border: 1px solid currentColor; color: currentColor; padding: 8px 12px; font-family: inherit; cursor: pointer; text-transform: uppercase; }
        .product-stage { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; padding: 20px; }
        
        /* TERMINAL */
        .data-terminal { width: 100%; max-width: 800px; height: 400px; border: 5px solid black; padding: 20px; font-family: 'Courier New', Courier, monospace; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-start; }
        .terminal-line { margin-bottom: 10px; display: block; word-break: break-all; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* FORM */
        .bottom-bar { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: flex-end; padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom)); z-index: 10; gap: 20px; flex-wrap: wrap; }
        .details { font-size: 0.8rem; line-height: 1.4; max-width: 300px; }
        .receipt-box { width: 400px; border: 2px solid black; padding: 15px; background: white; transition: border-color 0.3s, background 0.3s; }
        .receipt-header { border-bottom: 1px solid black; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .brutalist-input, .brutalist-select { width: 100%; padding: 15px; font-family: inherit; font-size: 1rem; border: 2px solid black; outline: none; margin-bottom: 10px; text-align: left; border-radius: 0; background: white; color: black; appearance: none; }
        .brutalist-btn { background: black; color: white; border: none; padding: 15px 30px; font-family: inherit; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; text-transform: uppercase; }
        .brutalist-btn:hover { background: white; color: black; border: 2px solid black; }
        .brutalist-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #ccc; color: #888; border: none; }

        @media (max-width: 768px) {
            .header-logo { height: 2.5rem; }
            .bottom-bar { display: block; }
            .details { margin-bottom: 20px; width: 100%; max-width: none; }
            .receipt-box { width: 100%; }
            .data-terminal { height: 300px; border-width: 2px; }
            .gate-logo { width: 140px; }
        }
    </style>
</head>
<body>

    <div id="gate">
        <h1 class="uppercase" style="margin-bottom: 20px; font-size: 2rem;">COCA</h1>
        <h2 class="uppercase" style="margin-bottom: 20px;">Restricted Access</h2>
        <div style="width: 300px; text-align: center;">
            <p style="margin-bottom: 20px; font-size: 0.8rem;">AUTHENTICATION REQUIRED</p>
            <button id="btn-login" class="brutalist-btn">INITIATE SESSION</button>
        </div>
        <p id="login-status" style="margin-top: 15px; color: var(--brand-red); font-size: 0.7rem; max-width: 300px; word-wrap: break-word;"></p>
    </div>

    <div id="app-interface" class="shop-container hidden"> 
        <div class="top-bar uppercase">
            <div class="header-group">
                <div class="header">COCA | TITHES</div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="status-indicator">ONLINE</div>
                <button class="dark-mode-toggle-btn">üåë DARK</button> 
            </div>
        </div>

        <div class="product-stage">
            <div class="data-terminal">
                <span class="terminal-line">> INITIALIZING SECURE CONNECTION...</span>
                <div id="terminal-content">
                    <span class="terminal-line"><span style="font-weight:bold;">WALLET:</span> <span id="disp-address" style="opacity:0.8;">LOADING...</span></span>
                    <br>
                    <span class="terminal-line">> WAITING FOR INPUT...<span class="blink">_</span></span>
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="details uppercase">
                <p>PROTOCOL: TITHE_V1</p>
                <p id="btn-logout" style="margin-top: 10px; cursor: pointer; text-decoration: underline;">[ DISCONNECT SESSION ]</p>
            </div>

            <div class="receipt-box">
                <div class="receipt-header uppercase"><span>TRANSACTION SLIP</span><span>#0001</span></div>
                
                <button id="btn-fund" class="brutalist-btn" style="margin-bottom: 15px; background: white; color: black; border: 2px solid black;">+ ADD FUNDS</button>

                <label class="uppercase" style="font-size: 0.7rem; font-weight: bold;">Tithe Amount</label>
                <select id="input-amount" class="brutalist-select">
                    <option value="0.001">0.001 ETH (~$3.00)</option>
                    <option value="0.01">0.010 ETH (~$30.00)</option>
                    <option value="CUSTOM">CUSTOM AMOUNT</option>
                </select>

                <div id="custom-amount-wrapper" class="hidden">
                     <input type="text" id="input-custom" class="brutalist-input" placeholder="0.00 ETH">
                </div>
                
                <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="mint-token" checked style="width: 20px; height: 20px; accent-color: black;">
                    <label for="mint-token" class="uppercase" style="font-size: 0.8rem;">MINT TOKEN</label>
                </div>

                <button id="btn-tithe" class="brutalist-btn">CONFIRM TITHE</button>
                <p id="tx-status" style="margin-top: 10px; font-size: 0.8rem; text-align: center; color: var(--brand-red); word-break: break-all;"></p>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. FIX: Use Named Import and specific version to prevent default export errors
        import { PrivyClient } from "https://esm.sh/@privy-io/js-sdk-core@1.60.0";

        const APP_ID = 'cmitb8a5900p6l40c4tkqqwbq'; 
        const RECIPIENT_WALLET = '0x0828C77922838a06587eBe8463aDBDeD6eb95f74';

        const els = {
            gate: document.getElementById('gate'),
            app: document.getElementById('app-interface'),
            btnLogin: document.getElementById('btn-login'),
            btnLogout: document.getElementById('btn-logout'),
            btnTithe: document.getElementById('btn-tithe'),
            btnFund: document.getElementById('btn-fund'),
            dispAddress: document.getElementById('disp-address'),
            loginStatus: document.getElementById('login-status'),
            txStatus: document.getElementById('tx-status'),
            selectAmount: document.getElementById('input-amount'),
            inputCustom: document.getElementById('input-custom'),
            customWrapper: document.getElementById('custom-amount-wrapper'),
            terminal: document.getElementById('terminal-content'),
            toggleBtn: document.querySelector('.dark-mode-toggle-btn')
        };

        let privy;

        async function init() {
            try {
                // 2. FIX: Initialize properly with named class
                privy = new PrivyClient({ appId: APP_ID });
                
                // Mount Iframe for Embedded Wallet
                // This prevents the "Cannot read properties of undefined" error
                const url = privy.embeddedWallet.getURL();
                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                await new Promise(resolve => iframe.onload = resolve);
                privy.setMessagePoster(iframe.contentWindow);
                window.addEventListener('message', (e) => privy.embeddedWallet.onMessage(e.data));

                // 3. FIX: Use getAuthenticatedUser() instead of getUser()
                const user = await privy.getAuthenticatedUser();
                if (user) {
                    enterApp(user);
                }
            } catch (e) {
                console.error(e);
                els.loginStatus.innerText = "SYSTEM ERROR: " + (e.message || JSON.stringify(e));
            }
        }

        async function enterApp(user) {
            els.gate.style.display = 'none';
            els.app.classList.remove('hidden');
            
            try {
                // Determine wallet type (embedded vs connected)
                const wallet = user.linked_accounts.find(a => a.type === 'wallet');
                
                if (wallet) {
                    els.dispAddress.innerText = wallet.address;
                    log(`IDENTITY VERIFIED: ${wallet.address}`);
                    log(`SESSION ACTIVE via ${wallet.wallet_client_type.toUpperCase()}`);
                }
            } catch (e) {
                log("ERROR PARSING USER DATA");
            }
        }

        function log(msg) {
            const span = document.createElement('span');
            span.className = 'terminal-line';
            span.innerText = `> ${msg}`;
            els.terminal.appendChild(span);
        }

        // 4. FIX: Brutalist Login Flow (Prompt-based)
        // Since JS-SDK-CORE has no Modal UI, we use window.prompt to match the brutalist vibe
        els.btnLogin.addEventListener('click', async () => {
            els.btnLogin.innerText = "AWAITING INPUT...";
            els.loginStatus.innerText = ""; 
            
            try {
                // Step 1: Get Email via Browser Native Prompt
                const email = window.prompt("TERMINAL LOGIN // ENTER EMAIL ADDRESS:");
                if(!email) {
                    els.btnLogin.innerText = "INITIATE SESSION";
                    return;
                }

                els.loginStatus.innerText = "SENDING OTP...";
                await privy.loginWithEmail(email);

                // Step 2: Get OTP via Browser Native Prompt
                const code = window.prompt(`ENTER ACCESS CODE SENT TO ${email.toUpperCase()}:`);
                if(!code) {
                    throw new Error("NO CODE ENTERED");
                }

                els.loginStatus.innerText = "VERIFYING...";
                const user = await privy.loginWithCode(code);
                
                enterApp(user);
            } catch (e) {
                console.error(e);
                els.loginStatus.innerText = "LOGIN FAILED: " + (e.message || "UNKNOWN");
                els.btnLogin.innerText = "TRY AGAIN";
            }
        });

        els.btnLogout.addEventListener('click', async () => {
            await privy.logout();
            window.location.reload();
        });

        els.selectAmount.addEventListener('change', (e) => {
            els.customWrapper.classList.toggle('hidden', e.target.value !== 'CUSTOM');
        });

        els.btnFund.addEventListener('click', () => {
             const addr = els.dispAddress.innerText;
             navigator.clipboard.writeText(addr);
             els.txStatus.innerText = "ADDR COPIED. SEND ETH TO FUND.";
             log("ADDR COPIED TO CLIPBOARD");
        });

        els.btnTithe.addEventListener('click', async () => {
            els.btnTithe.innerText = "PROCESSING...";
            els.txStatus.innerText = "INITIATING...";
            
            let amount = els.selectAmount.value === 'CUSTOM' ? els.inputCustom.value : els.selectAmount.value;

            try {
                // 5. FIX: Ensure provider is fetched from the Embedded Wallet correctly
                const provider = await privy.embeddedWallet.getEthereumProvider();
                
                const wei = BigInt(Math.floor(parseFloat(amount) * 1e18)).toString(16);
                
                log(`REQ SIGNATURE: ${amount} ETH -> RECIPIENT`);

                const tx = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: els.dispAddress.innerText,
                        to: RECIPIENT_WALLET,
                        value: '0x' + wei
                    }]
                });

                log(`TX SUCCESS: ${tx}`);
                els.txStatus.innerText = "SENT! HASH: " + tx.substring(0,8) + "...";
                els.txStatus.style.color = "#0f0";
            } catch (e) {
                console.error(e);
                // Handle insufficient funds specifically
                if(e.message && e.message.includes("insufficient funds")) {
                    els.txStatus.innerText = "ERROR: INSUFFICIENT FUNDS";
                    log("ERR: WALLET EMPTY. USE '+ ADD FUNDS'");
                } else {
                    els.txStatus.innerText = "FAILED: " + (e.message || "UNKNOWN");
                }
                els.txStatus.style.color = "var(--brand-red)";
            } finally {
                els.btnTithe.innerText = "CONFIRM TITHE";
            }
        });

        const toggleBtn = els.toggleBtn;
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            toggleBtn.textContent = '‚òÄÔ∏è LIGHT';
        }
        toggleBtn.addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-mode');
            toggleBtn.textContent = isDark ? '‚òÄÔ∏è LIGHT' : 'üåë DARK';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        init();
    </script>
</body>
</html>
